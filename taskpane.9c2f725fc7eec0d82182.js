(()=>{"use strict";var n={56(n,e,t){n.exports=function(n){var e=t.nc;e&&n.setAttribute("nonce",e)}},72(n){var e=[];function t(n){for(var t=-1,r=0;r<e.length;r++)if(e[r].identifier===n){t=r;break}return t}function r(n,r){for(var a={},i=[],s=0;s<n.length;s++){var c=n[s],l=r.base?c[0]+r.base:c[0],d=a[l]||0,u="".concat(l," ").concat(d);a[l]=d+1;var p=t(u),m={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==p)e[p].references++,e[p].updater(m);else{var f=o(m,r);r.byIndex=s,e.splice(s,0,{identifier:u,updater:f,references:1})}i.push(u)}return i}function o(n,e){var t=e.domAPI(e);return t.update(n),function(e){if(e){if(e.css===n.css&&e.media===n.media&&e.sourceMap===n.sourceMap&&e.supports===n.supports&&e.layer===n.layer)return;t.update(n=e)}else t.remove()}}n.exports=function(n,o){var a=r(n=n||[],o=o||{});return function(n){n=n||[];for(var i=0;i<a.length;i++){var s=t(a[i]);e[s].references--}for(var c=r(n,o),l=0;l<a.length;l++){var d=t(a[l]);0===e[d].references&&(e[d].updater(),e.splice(d,1))}a=c}}},113(n){n.exports=function(n,e){if(e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}},314(n){n.exports=function(n){var e=[];return e.toString=function(){return this.map(function(e){var t="",r=void 0!==e[5];return e[4]&&(t+="@supports (".concat(e[4],") {")),e[2]&&(t+="@media ".concat(e[2]," {")),r&&(t+="@layer".concat(e[5].length>0?" ".concat(e[5]):""," {")),t+=n(e),r&&(t+="}"),e[2]&&(t+="}"),e[4]&&(t+="}"),t}).join("")},e.i=function(n,t,r,o,a){"string"==typeof n&&(n=[[null,n,void 0]]);var i={};if(r)for(var s=0;s<this.length;s++){var c=this[s][0];null!=c&&(i[c]=!0)}for(var l=0;l<n.length;l++){var d=[].concat(n[l]);r&&i[d[0]]||(void 0!==a&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=a),t&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=t):d[2]=t),o&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=o):d[4]="".concat(o)),e.push(d))}},e}},540(n){n.exports=function(n){var e=document.createElement("style");return n.setAttributes(e,n.attributes),n.insert(e,n.options),e}},601(n){n.exports=function(n){return n[1]}},659(n){var e={};n.exports=function(n,t){var r=function(n){if(void 0===e[n]){var t=document.querySelector(n);if(window.HTMLIFrameElement&&t instanceof window.HTMLIFrameElement)try{t=t.contentDocument.head}catch(n){t=null}e[n]=t}return e[n]}(n);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(t)}},825(n){n.exports=function(n){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var e=n.insertStyleElement(n);return{update:function(t){!function(n,e,t){var r="";t.supports&&(r+="@supports (".concat(t.supports,") {")),t.media&&(r+="@media ".concat(t.media," {"));var o=void 0!==t.layer;o&&(r+="@layer".concat(t.layer.length>0?" ".concat(t.layer):""," {")),r+=t.css,o&&(r+="}"),t.media&&(r+="}"),t.supports&&(r+="}");var a=t.sourceMap;a&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(a))))," */")),e.styleTagTransform(r,n,e.options)}(e,n,t)},remove:function(){!function(n){if(null===n.parentNode)return!1;n.parentNode.removeChild(n)}(e)}}}},942(n,e,t){t.d(e,{A:()=>s});var r=t(601),o=t.n(r),a=t(314),i=t.n(a)()(o());i.push([n.id,"/* AI Excel å¯¹è¯æ’ä»¶æ ·å¼ */\n\n:root {\n    --primary-color: #217346;\n    --primary-hover: #1a5c37;\n    --primary-light: #e8f5ed;\n    --secondary-color: #0078d4;\n    --background: #fafafa;\n    --surface: #ffffff;\n    --text-primary: #1f2937;\n    --text-secondary: #6b7280;\n    --border-color: #e5e7eb;\n    --error-color: #dc2626;\n    --error-bg: #fef2f2;\n    --success-color: #059669;\n    --success-bg: #ecfdf5;\n    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);\n    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);\n    --radius-sm: 6px;\n    --radius-md: 10px;\n    --radius-lg: 16px;\n}\n\n* {\n    box-sizing: border-box;\n    margin: 0;\n    padding: 0;\n}\n\nbody {\n    font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;\n    background: var(--background);\n    color: var(--text-primary);\n    font-size: 14px;\n    line-height: 1.5;\n    height: 100vh;\n    overflow: hidden;\n}\n\n.container {\n    display: flex;\n    flex-direction: column;\n    height: 100vh;\n    max-width: 400px;\n    margin: 0 auto;\n}\n\n/* å¤´éƒ¨æ ·å¼ */\n.header {\n    background: linear-gradient(135deg, var(--primary-color), #1a5c37);\n    color: white;\n    padding: 16px 20px;\n    text-align: center;\n    position: relative;\n}\n\n.logo {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 8px;\n    margin-bottom: 4px;\n}\n\n.logo .icon {\n    width: 24px;\n    height: 24px;\n}\n\n.logo h1 {\n    font-size: 18px;\n    font-weight: 600;\n}\n\n.subtitle {\n    font-size: 12px;\n    opacity: 0.9;\n}\n\n/* è®¾ç½®æŒ‰é’® */\n.settings-btn {\n    position: absolute;\n    right: 16px;\n    top: 50%;\n    transform: translateY(-50%);\n    width: 32px;\n    height: 32px;\n    border: none;\n    border-radius: 50%;\n    background: rgba(255, 255, 255, 0.2);\n    color: white;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: background 0.2s;\n    z-index: 10;\n    pointer-events: auto;\n}\n\n.settings-btn:hover {\n    background: rgba(255, 255, 255, 0.3);\n}\n\n.settings-btn svg {\n    width: 18px;\n    height: 18px;\n}\n\n/* AI æ¨¡å¼æŒ‡ç¤ºå™¨ */\n.ai-mode-indicator {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 6px;\n    padding: 6px 12px;\n    background: var(--surface);\n    border-bottom: 1px solid var(--border-color);\n    font-size: 12px;\n    color: var(--text-secondary);\n}\n\n.mode-dot {\n    width: 8px;\n    height: 8px;\n    border-radius: 50%;\n    background: var(--text-secondary);\n}\n\n.mode-dot.local {\n    background: #6b7280;\n}\n\n.mode-dot.ai {\n    background: var(--success-color);\n    animation: pulse 2s infinite;\n}\n\n@keyframes pulse {\n\n    0%,\n    100% {\n        opacity: 1;\n    }\n\n    50% {\n        opacity: 0.5;\n    }\n}\n\n/* é€‰åŒºçŠ¶æ€ */\n.selection-status {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    padding: 10px 16px;\n    background: var(--primary-light);\n    border-bottom: 1px solid var(--border-color);\n    font-size: 13px;\n    color: var(--primary-color);\n}\n\n.selection-status.active {\n    background: var(--success-bg);\n    color: var(--success-color);\n}\n\n.selection-status.error {\n    background: var(--error-bg);\n    color: var(--error-color);\n}\n\n.status-icon {\n    font-size: 16px;\n}\n\n/* å¯¹è¯åŒºåŸŸ */\n.chat-container {\n    flex: 1;\n    overflow-y: auto;\n    padding: 16px;\n    display: flex;\n    flex-direction: column;\n    gap: 12px;\n}\n\n.message {\n    max-width: 90%;\n    animation: fadeIn 0.3s ease;\n}\n\n@keyframes fadeIn {\n    from {\n        opacity: 0;\n        transform: translateY(8px);\n    }\n\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n.message.user {\n    align-self: flex-end;\n}\n\n.message.assistant,\n.message.error {\n    align-self: flex-start;\n}\n\n.message-content {\n    padding: 12px 16px;\n    border-radius: var(--radius-md);\n    box-shadow: var(--shadow-sm);\n}\n\n.message.user .message-content {\n    background: var(--primary-color);\n    color: white;\n    border-bottom-right-radius: 4px;\n}\n\n.message.assistant .message-content {\n    background: var(--surface);\n    border: 1px solid var(--border-color);\n    border-bottom-left-radius: 4px;\n}\n\n.message.error .message-content {\n    background: var(--error-bg);\n    border: 1px solid var(--error-color);\n    color: var(--error-color);\n}\n\n.message-content p {\n    margin-bottom: 8px;\n}\n\n.message-content p:last-child {\n    margin-bottom: 0;\n}\n\n.examples-title {\n    font-weight: 500;\n    margin-top: 8px;\n}\n\n.examples {\n    list-style: none;\n    margin-top: 4px;\n}\n\n.examples li {\n    padding: 4px 0;\n    padding-left: 16px;\n    position: relative;\n    color: var(--text-secondary);\n    font-size: 13px;\n}\n\n.examples li::before {\n    content: 'â€¢';\n    position: absolute;\n    left: 4px;\n    color: var(--primary-color);\n}\n\n/* ç»“æœå±•ç¤º */\n.result-value {\n    font-size: 24px;\n    font-weight: 600;\n    color: var(--primary-color);\n    margin: 8px 0;\n}\n\n.result-formula {\n    font-size: 12px;\n    color: var(--text-secondary);\n    background: var(--background);\n    padding: 4px 8px;\n    border-radius: var(--radius-sm);\n    display: inline-block;\n    margin-top: 4px;\n}\n\n/* è¾“å…¥åŒºåŸŸ */\n.input-container {\n    padding: 12px 16px;\n    background: var(--surface);\n    border-top: 1px solid var(--border-color);\n}\n\n.input-wrapper {\n    display: flex;\n    align-items: flex-end;\n    gap: 8px;\n    background: var(--background);\n    border: 1px solid var(--border-color);\n    border-radius: var(--radius-md);\n    padding: 8px 12px;\n    transition: border-color 0.2s, box-shadow 0.2s;\n}\n\n.input-wrapper:focus-within {\n    border-color: var(--primary-color);\n    box-shadow: 0 0 0 3px var(--primary-light);\n}\n\n.input-field {\n    flex: 1;\n    border: none;\n    background: transparent;\n    font-size: 14px;\n    line-height: 1.5;\n    resize: none;\n    max-height: 100px;\n    outline: none;\n    font-family: inherit;\n}\n\n.input-field::placeholder {\n    color: var(--text-secondary);\n}\n\n.submit-btn {\n    width: 36px;\n    height: 36px;\n    border: none;\n    border-radius: 50%;\n    background: var(--primary-color);\n    color: white;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: background 0.2s, transform 0.1s;\n    flex-shrink: 0;\n}\n\n.submit-btn:hover {\n    background: var(--primary-hover);\n}\n\n.submit-btn:active {\n    transform: scale(0.95);\n}\n\n.submit-btn svg {\n    width: 18px;\n    height: 18px;\n}\n\n/* æ“ä½œæŒ‰é’® */\n.action-buttons {\n    display: flex;\n    gap: 8px;\n    margin-top: 10px;\n}\n\n.action-btn {\n    flex: 1;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 6px;\n    padding: 8px 12px;\n    border: 1px solid var(--border-color);\n    border-radius: var(--radius-sm);\n    background: var(--surface);\n    color: var(--text-secondary);\n    font-size: 13px;\n    cursor: pointer;\n    transition: all 0.2s;\n}\n\n.action-btn:hover:not(:disabled) {\n    background: var(--background);\n    color: var(--text-primary);\n    border-color: var(--text-secondary);\n}\n\n.action-btn:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n}\n\n.action-btn svg {\n    width: 16px;\n    height: 16px;\n}\n\n.fill-btn:hover:not(:disabled) {\n    border-color: var(--primary-color);\n    color: var(--primary-color);\n}\n\n.clear-btn:hover:not(:disabled) {\n    border-color: var(--error-color);\n    color: var(--error-color);\n}\n\n/* åŠ è½½åŠ¨ç”» */\n.loading-overlay {\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: rgba(255, 255, 255, 0.9);\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n    gap: 12px;\n    z-index: 100;\n}\n\n.loading-spinner {\n    width: 40px;\n    height: 40px;\n    border: 3px solid var(--border-color);\n    border-top-color: var(--primary-color);\n    border-radius: 50%;\n    animation: spin 1s linear infinite;\n}\n\n@keyframes spin {\n    to {\n        transform: rotate(360deg);\n    }\n}\n\n/* è®¾ç½®å¼¹çª— */\n.settings-modal {\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: rgba(0, 0, 0, 0.5);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 200;\n    animation: fadeIn 0.2s ease;\n}\n\n.settings-content {\n    background: var(--surface);\n    border-radius: var(--radius-lg);\n    width: 90%;\n    max-width: 360px;\n    max-height: 90vh;\n    overflow-y: auto;\n    box-shadow: var(--shadow-md);\n}\n\n.settings-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 16px 20px;\n    border-bottom: 1px solid var(--border-color);\n}\n\n.settings-header h2 {\n    font-size: 16px;\n    font-weight: 600;\n    color: var(--text-primary);\n}\n\n.close-btn {\n    width: 28px;\n    height: 28px;\n    border: none;\n    border-radius: 50%;\n    background: var(--background);\n    color: var(--text-secondary);\n    cursor: pointer;\n    font-size: 20px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: all 0.2s;\n}\n\n.close-btn:hover {\n    background: var(--border-color);\n    color: var(--text-primary);\n}\n\n.settings-body {\n    padding: 20px;\n}\n\n.form-group {\n    margin-bottom: 16px;\n}\n\n.form-group label {\n    display: block;\n    margin-bottom: 6px;\n    font-size: 13px;\n    font-weight: 500;\n    color: var(--text-primary);\n}\n\n.form-control {\n    width: 100%;\n    padding: 10px 12px;\n    border: 1px solid var(--border-color);\n    border-radius: var(--radius-sm);\n    font-size: 14px;\n    color: var(--text-primary);\n    background: var(--surface);\n    transition: border-color 0.2s, box-shadow 0.2s;\n}\n\n.form-control:focus {\n    outline: none;\n    border-color: var(--primary-color);\n    box-shadow: 0 0 0 3px var(--primary-light);\n}\n\n.form-hint {\n    display: block;\n    margin-top: 4px;\n    font-size: 12px;\n    color: var(--text-secondary);\n}\n\n.provider-info {\n    padding: 12px;\n    background: var(--background);\n    border-radius: var(--radius-sm);\n    font-size: 13px;\n    color: var(--text-secondary);\n}\n\n.provider-info p {\n    margin: 0;\n}\n\n.settings-footer {\n    display: flex;\n    gap: 8px;\n    padding: 16px 20px;\n    border-top: 1px solid var(--border-color);\n}\n\n.btn {\n    flex: 1;\n    padding: 10px 16px;\n    border: none;\n    border-radius: var(--radius-sm);\n    font-size: 14px;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s;\n}\n\n.btn-primary {\n    background: var(--primary-color);\n    color: white;\n}\n\n.btn-primary:hover {\n    background: var(--primary-hover);\n}\n\n.btn-secondary {\n    background: var(--background);\n    color: var(--text-primary);\n    border: 1px solid var(--border-color);\n}\n\n.btn-secondary:hover {\n    background: var(--border-color);\n}\n\n/* æ»šåŠ¨æ¡æ ·å¼ */\n.chat-container::-webkit-scrollbar {\n    width: 6px;\n}\n\n.chat-container::-webkit-scrollbar-track {\n    background: transparent;\n}\n\n.chat-container::-webkit-scrollbar-thumb {\n    background: var(--border-color);\n    border-radius: 3px;\n}\n\n.chat-container::-webkit-scrollbar-thumb:hover {\n    background: var(--text-secondary);\n}\n\n/* å“åº”å¼è°ƒæ•´ */\n@media (max-height: 500px) {\n    .header {\n        padding: 12px 16px;\n    }\n\n    .chat-container {\n        padding: 12px;\n    }\n}",""]);const s=i}},e={};function t(r){var o=e[r];if(void 0!==o)return o.exports;var a=e[r]={id:r,exports:{}};return n[r](a,a.exports,t),a.exports}t.n=n=>{var e=n&&n.__esModule?()=>n.default:()=>n;return t.d(e,{a:e}),e},t.d=(n,e)=>{for(var r in e)t.o(e,r)&&!t.o(n,r)&&Object.defineProperty(n,r,{enumerable:!0,get:e[r]})},t.o=(n,e)=>Object.prototype.hasOwnProperty.call(n,e),t.nc=void 0;var r,o=t(72),a=t.n(o),i=t(825),s=t.n(i),c=t(659),l=t.n(c),d=t(56),u=t.n(d),p=t(540),m=t.n(p),f=t(113),g=t.n(f),h=t(942),y={};y.styleTagTransform=g(),y.setAttributes=u(),y.insert=l().bind(null,"head"),y.domAPI=s(),y.insertStyleElement=m(),a()(h.A,y),h.A&&h.A.locals&&h.A.locals,function(n){n.NO_SELECTION="NO_SELECTION",n.INVALID_DATA="INVALID_DATA",n.PARSE_ERROR="PARSE_ERROR",n.CALCULATION_ERROR="CALCULATION_ERROR",n.CHART_ERROR="CHART_ERROR",n.API_ERROR="API_ERROR",n.FIELD_NOT_FOUND="FIELD_NOT_FOUND"}(r||(r={}));class v extends Error{constructor(n,e){super(e),this.type=n,this.name="PluginError"}}function b(n,e){return 0===e.length?n.data:n.data.filter(n=>e.every(e=>{const t=n[e.field];if(null==t)return!1;const r=String(t).toLowerCase(),o=String(e.value).toLowerCase();switch(e.operator){case"equals":default:return r===o;case"contains":return r.includes(o);case"greater":return Number(t)>Number(e.value);case"less":return Number(t)<Number(e.value)}}))}function x(n,e){const t=["é”€å”®é¢","é‡‘é¢","æ•°é‡","ä»·æ ¼","æˆæœ¬","åˆ©æ¶¦","æ”¶å…¥"];for(const e of n)if(t.some(n=>e.includes(n)))return e;if(e.length>0)for(const t of n){const n=e[0][t];if("number"==typeof n||!isNaN(parseFloat(String(n))))return t}}function w(n,e){return 0===n.length||0===e.length?{valid:!1,message:"æ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®ç”Ÿæˆå›¾è¡¨"}:n.length!==e.length?{valid:!1,message:"æ•°æ®ç»´åº¦ä¸åŒ¹é…"}:n.length>20?{valid:!0,message:`æ•°æ®åˆ†ç±»è¾ƒå¤šï¼ˆ${n.length}ä¸ªï¼‰ï¼Œå›¾è¡¨å¯èƒ½ä¸å¤Ÿæ¸…æ™°`}:{valid:!0}}function E(n){return{bar:"æŸ±çŠ¶å›¾",line:"æŠ˜çº¿å›¾",pie:"é¥¼å›¾"}[n]||"å›¾è¡¨"}const k={æ€»:"sum",åˆè®¡:"sum",æ€»è®¡:"sum",æ±‚å’Œ:"sum",æ€»å’Œ:"sum",åŠ èµ·æ¥:"sum",ä¸€å…±:"sum",å¹³å‡:"avg",å‡å€¼:"avg",å¹³å‡å€¼:"avg",æœ€å¤§:"max",æœ€é«˜:"max",æœ€å¤§å€¼:"max",æœ€å°:"min",æœ€ä½:"min",æœ€å°å€¼:"min",æ•°é‡:"count",ä¸ªæ•°:"count",å¤šå°‘ä¸ª:"count",æœ‰å¤šå°‘:"count",å‡ ä¸ª:"count",ç»Ÿè®¡:"count"},I={æŸ±çŠ¶å›¾:"bar",æŸ±å½¢å›¾:"bar",æ¡å½¢å›¾:"bar",æŠ˜çº¿å›¾:"line",çº¿å›¾:"line",æ›²çº¿å›¾:"line",è¶‹åŠ¿å›¾:"line",é¥¼å›¾:"pie",é¥¼çŠ¶å›¾:"pie",åœ†å½¢å›¾:"pie",å æ¯”å›¾:"pie"},A={å¤§äº:"greater",è¶…è¿‡:"greater",é«˜äº:"greater",å°äº:"less",ä½äº:"less",ä¸è¶³:"less",ç­‰äº:"equals",æ˜¯:"equals",ä¸º:"equals",åŒ…å«:"contains",å«æœ‰:"contains"},C=["å›¾","å¯è§†åŒ–","å±•ç¤º","æ˜¾ç¤º","ç”»","åš","ç”Ÿæˆ","åˆ›å»º"];function S(n,e){const t=[];for(const r of e){const e=[new RegExp(`${r}[æ˜¯ä¸º:ï¼š]?\\s*([^\\s,ï¼Œã€‚]+)`,"i"),new RegExp(`([^\\s,ï¼Œã€‚çš„]+)çš„${r}`,"i")];for(const o of e){const e=n.match(o);if(e&&e[1]){const n=e[1].trim();if(!O(n)){t.push({field:r,value:n,operator:"equals"});break}}}}if(0===t.length){const r=n.split(/[ï¼Œ,ã€‚ï¼Ÿ?ï¼!\sçš„æ˜¯ä¸º]+/).filter(n=>n.length>0);for(const n of r){if(O(n))continue;const r=e.filter(n=>!(n.includes("é‡‘é¢")||n.includes("é”€å”®é¢")||n.includes("æ•°é‡")||n.includes("ä»·æ ¼")));r.length>0&&!t.some(n=>n.field===r[0])&&t.push({field:r[0],value:n,operator:"contains"})}}return t}function O(n){return[...Object.keys(k),...Object.keys(I),...Object.keys(A),...C,"æ˜¯å¤šå°‘","å¤šå°‘","ä»€ä¹ˆ","å“ªä¸ª","å“ªäº›","æ€ä¹ˆ","å¦‚ä½•"].some(e=>n.includes(e)||e.includes(n))}const N={bar:Excel.ChartType.columnClustered,line:Excel.ChartType.line,pie:Excel.ChartType.pie};async function T(n,e="current"){return Excel.run(async t=>{let r;r="newSheet"===e?t.workbook.worksheets.add("å›¾è¡¨"):t.workbook.worksheets.getActiveWorksheet();const o=t.workbook.getSelectedRange();o.load("address"),await t.sync();const a=N[n.type]||Excel.ChartType.columnClustered,i=r.charts.add(a,o,Excel.ChartSeriesBy.auto);i.title.text=n.title,i.title.visible=!0,"current"===e?i.setPosition("G2","N15"):i.setPosition("B2","L20"),await t.sync()})}const R={provider:"local",apiKey:"",model:""};let $,L,q,z,B,M,j,P,_,D,H,F,K,J,U,V,G,Y,W,X,Q=R;function Z(n){Q=n;try{localStorage.setItem("ai-excel-plugin-config",JSON.stringify(n))}catch(n){console.error("ä¿å­˜é…ç½®å¤±è´¥:",n)}}function nn(){return Q}function en(){return"local"!==Q.provider&&!!Q.apiKey}async function tn(n,e,t=[]){const r=nn();switch(r.provider){case"openai":return await async function(n,e,t,r=[]){const o=t.apiEndpoint||"https://api.openai.com/v1/chat/completions",a=t.model||"gpt-3.5-turbo",i=[{role:"system",content:n},...r.slice(-10).map(n=>({role:"user"===n.role?"user":"assistant",content:n.content})),{role:"user",content:e}],s=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.apiKey}`},body:JSON.stringify({model:a,messages:i,temperature:.1})});if(!s.ok){const n=await s.text();throw new Error(`OpenAI API é”™è¯¯: ${n}`)}return(await s.json()).choices[0].message.content}(n,e,r,t);case"azure":return await async function(n,e,t,r=[]){if(!t.apiEndpoint)throw new Error("Azure OpenAI éœ€è¦é…ç½® API ç«¯ç‚¹");const o=[{role:"system",content:n},...r.slice(-10).map(n=>({role:"user"===n.role?"user":"assistant",content:n.content})),{role:"user",content:e}],a=await fetch(t.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json","api-key":t.apiKey},body:JSON.stringify({messages:o,temperature:.1})});if(!a.ok){const n=await a.text();throw new Error(`Azure OpenAI API é”™è¯¯: ${n}`)}return(await a.json()).choices[0].message.content}(n,e,r,t);case"qwen":return await async function(n,e,t,r=[]){const o=t.apiEndpoint||"https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions",a=t.model||"qwen3-max",i=[{role:"system",content:n},...r.slice(-10).map(n=>({role:"user"===n.role?"user":"assistant",content:n.content})),{role:"user",content:e}],s=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.apiKey}`},body:JSON.stringify({model:a,messages:i,temperature:.1})});if(!s.ok){const n=await s.text();throw new Error(`é€šä¹‰åƒé—® API é”™è¯¯: ${n}`)}return(await s.json()).choices[0].message.content}(n,e,r,t);default:throw new Error("ä¸æ”¯æŒçš„ AI æä¾›å•†")}}function rn(n){return{bar:"bar",column:"bar",line:"line",pie:"pie"}[n?.toLowerCase()||""]||"bar"}function on(n){return{local:"æœ¬åœ°æ¨¡å¼",openai:"OpenAI",azure:"Azure OpenAI",qwen:"é€šä¹‰åƒé—®"}[n]||n}let an=[],sn=null,cn=null;async function ln(){const n=L.value.trim();if(n){pn("user",n),L.value="",L.style.height="auto",gn(!0);try{let e=!1;try{e=await async function(){return Excel.run(async n=>{const e=n.workbook.getSelectedRange();return e.load(["rowCount","columnCount"]),await n.sync(),e.rowCount>1&&e.columnCount>0})}()}catch(n){console.warn("Check selection failed:",n)}if(e)try{cn=await async function(){return Excel.run(async n=>{const e=n.workbook.getSelectedRange();e.load(["values","address","rowCount","columnCount"]),await n.sync();const t=e.values;if(!t||0===t.length)throw new v(r.INVALID_DATA,"è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå•å…ƒæ ¼çš„æ•°æ®");let o=[],a=1;if(1===t.length)o=t[0].map((n,e)=>`åˆ—${e+1}`),a=0;else{const n=t[0].map(n=>String(n).trim());o=n.some(n=>!n)?n.map((n,e)=>n||`åˆ—${e+1}`):n}const i=[];for(let n=a;n<t.length;n++){const e={};for(let r=0;r<o.length;r++)r<t[n].length&&(e[o[r]]=t[n][r]);i.push(e)}return{headers:o,data:i}})}(),fn("active",`å·²é€‰æ‹© ${cn.data.length} è¡Œæ•°æ®`)}catch(n){console.warn("Get data failed:",n),e=!1}if(!e){if(!en())throw new v(r.NO_SELECTION,"è¯·å…ˆåœ¨ Excel ä¸­æ¡†é€‰åŒ…å«äº†è¡¨å¤´çš„æ•°æ®åŒºåŸŸ");cn={headers:[],data:[]}}if(en()){const e=an.slice(0,-1),t=cn||{headers:[],data:[]},r=await async function(n,e,t=[]){if(!en())throw new Error("AI æ¨¡å‹æœªé…ç½®ï¼Œè¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key");const r=function(n){if(!(n&&n.headers&&n.headers.length>0&&n.data&&n.data.length>0))return'ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½çš„ Excel åŠ©æ‰‹ã€‚\nç”¨æˆ·ç›®å‰æ²¡æœ‰åœ¨ Excel ä¸­é€‰æ‹©ä»»ä½•æ•°æ®ï¼Œæˆ–è€…é€‰æ‹©çš„æ•°æ®æ— æ•ˆã€‚\n\n## ä½ çš„ä»»åŠ¡\n1. **é—²èŠä¸å¼•å¯¼**ï¼šå¦‚æœç”¨æˆ·åªæ˜¯æ‰“æ‹›å‘¼ï¼ˆå¦‚"ä½ å¥½"ã€"ä»‹ç»è‡ªå·±"ï¼‰ï¼Œè¯·çƒ­æƒ…å›å¤ï¼Œå¹¶å‘Šè¯‰ç”¨æˆ·ä½ çš„æ ¸å¿ƒèƒ½åŠ›æ˜¯å¸®åŠ©åˆ†æ Excel æ•°æ®ã€‚\n2. **å¼•å¯¼é€‰åŒº**ï¼šå¦‚æœç”¨æˆ·é—®å…·ä½“çš„æ•°æ®é—®é¢˜ï¼ˆå¦‚"é”€å”®é¢æ˜¯å¤šå°‘"ï¼‰ï¼Œè¯·ç¤¼è²Œåœ°æç¤ºç”¨æˆ·å…ˆåœ¨ Excel ä¸­æ¡†é€‰åŒ…å«è¡¨å¤´çš„æ•°æ®åŒºåŸŸã€‚\n\n## è¿”å›æ ¼å¼\nç”±äºæ²¡æœ‰æ•°æ®ï¼Œæ— æ³•è¿›è¡ŒæŸ¥è¯¢æˆ–å›¾è¡¨ç”Ÿæˆã€‚è¯·ä»…è¿”å›é”™è¯¯ä¿¡æ¯ä½œä¸ºå›å¤ï¼ˆè¿™ä¼šè¢«æ˜¾ç¤ºä¸ºåŠ©æ‰‹çš„å›ç­”ï¼‰ï¼š\n{\n  "type": "unknown",\n  "errorMessage": "ä½ çš„å›å¤å†…å®¹ï¼ˆä¾‹å¦‚ï¼šä½ å¥½ï¼æˆ‘æ˜¯ AI Excel åŠ©æ‰‹ã€‚è¯·å…ˆæ¡†é€‰æ•°æ®ï¼Œæˆ‘æ‰èƒ½å¸®ä½ åˆ†æå“¦ã€‚ï¼‰"\n}';const e=n.data.map(e=>n.headers.map(n=>String(e[n]??"")).join("\t")).join("\n");return`ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½çš„æ•°æ®åˆ†æåŠ©æ‰‹ã€‚è¯·é€šè¿‡åˆ†æç”¨æˆ·æä¾›çš„è¡¨æ ¼æ•°æ®ï¼Œç†è§£å…¶è‡ªç„¶è¯­è¨€æ„å›¾ï¼Œå¹¶ç”Ÿæˆç²¾å‡†çš„åˆ†æç»“æœã€‚\n\n## åŸå§‹æ•°æ®è¡¨æ ¼\nåˆ—åï¼š${n.headers.join("\t")}\næ•°æ®ï¼ˆå…± ${n.data.length} è¡Œï¼‰ï¼š\n${e}\n\n## åˆ†ææ­¥éª¤æŒ‡å— (Chain of Thought)\nä½œä¸ºæ™ºèƒ½åŠ©æ‰‹ï¼Œè¯·æŒ‰ä»¥ä¸‹é€»è¾‘è¿›è¡Œæ€è€ƒï¼ˆæ— éœ€è¾“å‡ºæ€è€ƒè¿‡ç¨‹ï¼Œä»…è¾“å‡ºç»“æœï¼‰ï¼š\n\n1. **æ·±åº¦ç†è§£æ„å›¾**\n    - ç»“åˆå½“å‰è¯·æ±‚å’Œå†å²å¯¹è¯ï¼Œæ•æ‰ç”¨æˆ·çš„çœŸå®éœ€æ±‚ã€‚\n    - ä¾‹å¦‚ï¼šå¦‚æœç”¨æˆ·ä¹‹å‰å…³æ³¨"å¹¿å·"ï¼Œç°åœ¨è¯´"åšä¸ªå›¾"ï¼Œé€šå¸¸æ„å‘³ç€"åšå¹¿å·æ•°æ®çš„å›¾"ã€‚\n\n2. **æ™ºèƒ½æ•°æ®ç­›é€‰**\n    - æ ¹æ®ä½ çš„ç†è§£ï¼Œæå–å¿…è¦çš„ç­›é€‰æ¡ä»¶ã€‚\n    - åªæœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®æ‰åº”å‚ä¸åç»­çš„è®¡ç®—æˆ–ç»˜å›¾ã€‚\n\n3. **æ•°æ®èšåˆä¸è®¡ç®—**\n    - å¯¹äºå›¾è¡¨è¯·æ±‚ï¼Œè¯·æ ¹æ®é€»è¾‘è¿›è¡Œåˆç†çš„æ•°æ®èšåˆï¼ˆä¾‹å¦‚æŒ‰"äº§å“"åˆå¹¶é”€å”®é¢ï¼‰ã€‚\n    - ç¡®ä¿æ•°å€¼è®¡ç®—ç²¾ç¡®å¯é ã€‚\n\n## ç¤ºä¾‹å‚è€ƒ\n\n### åœºæ™¯ 1ï¼šä¸Šä¸‹æ–‡ç­›é€‰ä¸ç»˜å›¾\n**ç”¨æˆ·**ï¼š"åªçœ‹å¹¿å·çš„æ•°æ®" -> (AI å†…éƒ¨ç­›é€‰å‡ºå¹¿å·æ•°æ®)\n**ç”¨æˆ·**ï¼š"ç”Ÿæˆå„äº§å“é”€å”®é¢é¥¼å›¾"\n**AI å“åº”**ï¼š\n{\n  "chartResult": {\n    "title": "å¹¿å·å„äº§å“é”€å”®é¢å æ¯”",\n    "categories": ["æ‰‹æœº", "ç”µè„‘"], // å·²è‡ªåŠ¨ç­›é€‰å¹¿å·æ•°æ®å¹¶æŒ‰äº§å“èšåˆ\n    "values": [100, 200]\n  }\n}\n\n### åœºæ™¯ 2ï¼šå¤šæ¡ä»¶å¤æ‚è®¡ç®—\n**ç”¨æˆ·**ï¼š"è®¡ç®—å¹¿å·å’Œæ·±åœ³çš„æ‰‹æœºæ€»é”€é‡"\n**AI å“åº”**ï¼š\n{\n  "queryResult": {\n    "value": 400,\n    "description": "å¹¿å·å’Œæ·±åœ³çš„æ‰‹æœºæ€»é”€é‡ä¸º 400",\n    "formula": "SUM(å¹¿å·.æ‰‹æœº, æ·±åœ³.æ‰‹æœº)"\n  }\n}\n\n## è¾“å‡ºè¦æ±‚\nè¯·ç›´æ¥è¿”å› JSON æ ¼å¼ç»“æœï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\n\næ•°æ®æŸ¥è¯¢ï¼š\n{\n  "type": "query",\n  "queryResult": {\n    "value": number,\n    "description": "ç»“æœæè¿°",\n    "formula": "é€»è¾‘è¯´æ˜",\n    "filteredCount": ç­›é€‰åæ¡æ•°,\n    "totalCount": æ€»æ¡æ•°\n  }\n}\n\nå›¾è¡¨ç”Ÿæˆï¼š\n{\n  "type": "chart",\n  "chartResult": {\n    "chartType": "bar" | "line" | "pie",\n    "title": "å›¾è¡¨æ ‡é¢˜",\n    "categories": string[],\n    "values": number[],\n    "seriesName": "ç³»åˆ—å"\n  }\n}\n\nå¦‚æœæ— æ³•ç†è§£ï¼Œè¯·è¿”å› type: "unknown" å’Œé”™è¯¯è¯´æ˜ã€‚`}(e);return function(n,e){try{let t=n.trim();const r=t.match(/\{[\s\S]*\}/);if(!r)return console.warn("AI å“åº”ä¸­æœªæ‰¾åˆ° JSONï¼Œé™çº§ä¸ºæ™®é€šæ–‡æœ¬å›å¤"),{type:"unknown",errorMessage:n};t=r[0];const o=JSON.parse(t);if("query"===o.type&&o.queryResult){const n=o.queryResult;if(void 0===n.value||null===n.value){if(n.description)return{type:"query",queryResult:{value:0,description:n.description,formula:n.formula||"",filteredCount:0,totalCount:e.data.length}};throw new Error("è®¡ç®—ç»“æœç¼ºå¤±")}return{type:"query",queryResult:{value:n.value,description:n.description||"è®¡ç®—ç»“æœ",formula:n.formula||"",filteredCount:n.filteredCount||0,totalCount:e.data.length}}}if("chart"===o.type&&o.chartResult){const n=o.chartResult;if(!Array.isArray(n.categories)||!Array.isArray(n.values))throw new Error("å›¾è¡¨æ•°æ®æ ¼å¼é”™è¯¯");if(n.categories.length!==n.values.length)throw new Error("å›¾è¡¨ç±»åˆ«å’Œæ•°å€¼æ•°é‡ä¸åŒ¹é…");return{type:"chart",chartResult:{chartType:rn(n.chartType),title:n.title||"å›¾è¡¨",categories:n.categories.map(String),values:n.values.map(Number),seriesName:n.seriesName||"æ•°æ®"}}}return{type:"unknown",errorMessage:o.errorMessage||o.description||"æ— æ³•ç†è§£æ‚¨çš„è¯·æ±‚"}}catch(e){return console.error("è§£æ AI åˆ†æå“åº”å¤±è´¥:",e),console.warn("åŸå§‹å“åº”:",n),{type:"unknown",errorMessage:n}}}(await tn(r,n,t),e)}(n,t,e);await async function(n){if("query"===n.type&&n.queryResult){const e=n.queryResult;sn={value:e.value,description:e.description,formula:e.formula},mn(e.description,sn),z.disabled=!1,e.filteredCount>0&&e.filteredCount<e.totalCount&&pn("assistant",`ï¼ˆç­›é€‰äº† ${e.filteredCount}/${e.totalCount} æ¡æ•°æ®ï¼‰`)}else if("chart"===n.type&&n.chartResult){const e=n.chartResult,t=w(e.categories,e.values);if(!t.valid)return void pn("error",t.message||"å›¾è¡¨æ•°æ®æ— æ•ˆ");const r={type:e.chartType,title:e.title,sourceRange:"",categories:e.categories,values:e.values,seriesName:e.seriesName};await T(r),pn("assistant",`å·²æˆåŠŸç”Ÿæˆ${E(r.type)}ï¼š${r.title}ã€‚å…±åŒ…å« ${r.categories.length} ä¸ªæ•°æ®ç‚¹ã€‚`)}else pn("assistant",n.errorMessage||"æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰ç†è§£ä½ çš„æ„æ€ã€‚è¯·å°è¯•é‡æ–°æè¿°ä½ çš„éœ€æ±‚ã€‚")}(r)}else{if(!cn)throw new v(r.NO_SELECTION,"æœ¬åœ°æ¨¡å¼ä¸‹ï¼Œè¯·å…ˆåœ¨ Excel ä¸­æ¡†é€‰åŒ…å«äº†è¡¨å¤´çš„æ•°æ®åŒºåŸŸ");const e=function(n,e){return C.some(e=>n.includes(e))&&Object.keys(I).some(e=>n.includes(e))?function(n,e){const t={type:"chart",filters:[],chartType:void 0,dimensions:[],metrics:[]};for(const[e,r]of Object.entries(I))if(n.includes(e)){t.chartType=r;break}t.chartType||(t.chartType="bar");const r=e.filter(e=>n.includes(e));if(r.length>=2)t.dimensions=[r[0]],t.metrics=[r[1]];else if(1===r.length){t.metrics=[r[0]];const n=e.filter(n=>!r.includes(n));n.length>0&&(t.dimensions=[n[0]])}else e.length>=2&&(t.dimensions=[e[0]],t.metrics=[e[e.length-1]]);return t.filters=S(n,e),t}(n,e):function(n,e){const t={type:"query",filters:[],calculation:void 0,targetField:void 0};for(const[e,r]of Object.entries(k))if(n.includes(e)){t.calculation=r;break}t.calculation||(t.calculation="sum");const r=n.match(new RegExp(`(${["é”€å”®é¢","é‡‘é¢","æ•°é‡","ä»·æ ¼","æˆæœ¬","åˆ©æ¶¦","æ”¶å…¥","æ”¯å‡º","æ€»é¢","æ€»æ•°","æ•°ç›®"].join("|")})`,"g"));if(r){const n=function(n,e){const t=e.find(e=>e===n);if(t)return t;const r=e.find(e=>e.includes(n)||n.includes(e));if(r)return r;const o=["é¢","é‡","ä»·","æ•°","é‡‘","å€¼"];return e.find(n=>o.some(e=>n.includes(e)))}(r[0],e);n&&(t.targetField=n)}if(!t.targetField)for(const r of e)if(n.includes(r)){t.targetField=r;break}return t.filters=S(n,e),t}(n,e)}(n,cn.headers);"query"===e.type?await async function(n,e){let t=n.targetField;if(t||(t=x(e.headers,e.data)),!t)return void pn("error",'æ— æ³•ç¡®å®šè¦è®¡ç®—çš„æ•°å€¼å­—æ®µã€‚è¯·åœ¨é—®é¢˜ä¸­æ˜ç¡®æŒ‡å®šï¼Œå¦‚"é”€å”®é¢çš„æ€»å’Œ"');const o=b(e,n.filters);if(0===o.length)return void pn("assistant","æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ•°æ®ã€‚è¯·æ£€æŸ¥ç­›é€‰æ¡ä»¶æ˜¯å¦æ­£ç¡®ã€‚");const a=function(n,e,t){if(0===n.length)return{value:0,description:"æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ•°æ®",formula:`${t.toUpperCase()}(ç©ºé›†)`};const o=n.map(n=>{const t=n[e];if("number"==typeof t)return t;if("string"==typeof t){const n=parseFloat(t.replace(/[,ï¼Œ]/g,""));return isNaN(n)?null:n}return null}).filter(n=>null!==n);if(0===o.length)throw new v(r.INVALID_DATA,`å­—æ®µ"${e}"ä¸­æ²¡æœ‰æœ‰æ•ˆçš„æ•°å€¼æ•°æ®`);let a,i;switch(t){case"sum":default:a=o.reduce((n,e)=>n+e,0),i=`SUM(${o.length}ä¸ªå€¼)`;break;case"avg":a=o.reduce((n,e)=>n+e,0)/o.length,i=`AVG(${o.length}ä¸ªå€¼)`;break;case"max":a=Math.max(...o),i=`MAX(${o.length}ä¸ªå€¼)`;break;case"min":a=Math.min(...o),i=`MIN(${o.length}ä¸ªå€¼)`;break;case"count":a=o.length,i=`COUNT(${o.length}ä¸ªå€¼)`}return{value:a,description:"è®¡ç®—ç»“æœ",formula:i}}(o,t,n.calculation||"sum");sn=a,mn(function(n,e,t,r){let o="";r.length>0&&(o=r.map(n=>`${n.field}ä¸º"${n.value}"`).join("ã€")+"çš„");const a="number"==typeof e?e.toLocaleString("zh-CN",{maximumFractionDigits:2}):e;return`${o}${t}çš„${{sum:"æ€»å’Œ",avg:"å¹³å‡å€¼",max:"æœ€å¤§å€¼",min:"æœ€å°å€¼",count:"æ•°é‡"}[n]}æ˜¯ï¼š${a}`}(n.calculation||"sum",a.value,t,n.filters),a),z.disabled=!1}(e,cn):"chart"===e.type?await async function(n,e){const t=n.dimensions?.[0]||e.headers[0],r=n.metrics?.[0]||x(e.headers,e.data)||e.headers[e.headers.length-1],o=function(n,e,t,r,o=[],a){const{categories:i,values:s}=function(n,e,t,r=[]){const o=b(n,r),a=new Map;for(const n of o){const r=String(n[e]||"æœªçŸ¥"),o=parseFloat(String(n[t]).replace(/[,ï¼Œ]/g,""))||0,i=a.get(r)||0;a.set(r,i+o)}const i=[],s=[];return a.forEach((n,e)=>{i.push(e),s.push(n)}),{categories:i,values:s}}(n,t,r,o);return{type:e,title:a||`${t}ä¸${r}${E(e)}`,sourceRange:"",categories:i,values:s,seriesName:r}}(e,n.chartType||"bar",t,r,n.filters),a=w(o.categories,o.values);a.valid?(await T(o),pn("assistant",`å·²æˆåŠŸç”Ÿæˆ${E(o.type)}ï¼š${o.title}ã€‚å…±åŒ…å« ${o.categories.length} ä¸ªæ•°æ®ç‚¹ã€‚`),a.message&&pn("assistant",`æç¤ºï¼š${a.message}`)):pn("error",a.message||"æ— æ³•ç”Ÿæˆå›¾è¡¨")}(e,cn):pn("assistant",'æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰ç†è§£ä½ çš„æ„æ€ã€‚è¯·å°è¯•ï¼š\nâ€¢ æŸ¥è¯¢æ•°æ®ï¼Œå¦‚"æ€»é”€å”®é¢æ˜¯å¤šå°‘ï¼Ÿ"\nâ€¢ ç”Ÿæˆå›¾è¡¨ï¼Œå¦‚"å„åŒºåŸŸé”€å”®é¢åšæŸ±çŠ¶å›¾"')}}catch(n){hn(n)}finally{gn(!1)}}}async function dn(){if(sn){gn(!0);try{pn("assistant",`ç»“æœå·²å¡«å……åˆ°å•å…ƒæ ¼ ${await async function(n,e={row:0,col:1}){return Excel.run(async t=>{const r=t.workbook.getSelectedRange();r.load("address"),await t.sync();const o=r.getLastCell().getOffsetRange(e.row,e.col);return o.values=[[n]],o.load("address"),await t.sync(),o.address})}(sn.value)}`)}catch(n){hn(n)}finally{gn(!1)}}}function un(){const n=$.querySelector(".message.assistant");$.innerHTML="",n&&$.appendChild(n),an=[],sn=null,z.disabled=!0}function pn(n,e){const t={id:Date.now().toString(),role:n,content:e,timestamp:new Date};an.push(t);const r=document.createElement("div");r.className=`message ${n}`,r.innerHTML=`\n    <div class="message-content">\n      <p>${kn(e).replace(/\n/g,"</p><p>")}</p>\n    </div>\n  `,$.appendChild(r),$.scrollTop=$.scrollHeight}function mn(n,e){const t={id:Date.now().toString(),role:"assistant",content:n,timestamp:new Date,result:e};an.push(t);const r="number"==typeof e.value?e.value.toLocaleString("zh-CN",{maximumFractionDigits:2}):e.value,o=document.createElement("div");o.className="message assistant",o.innerHTML=`\n    <div class="message-content">\n      <p>${kn(n)}</p>\n      <div class="result-value">${r}</div>\n      ${e.formula?`<span class="result-formula">${kn(e.formula)}</span>`:""}\n    </div>\n  `,$.appendChild(o),$.scrollTop=$.scrollHeight}function fn(n,e){M.className="selection-status "+("active"===n?"active":"error"===n?"error":"");const t=M.querySelector(".status-icon"),r=M.querySelector(".status-text");t.textContent="active"===n?"âœ“":"error"===n?"âš ï¸":"ğŸ“Š",r.textContent=e}function gn(n){j.style.display=n?"flex":"none"}function hn(n){console.error("Error:",n);let e="å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼Œè¯·é‡è¯•";n instanceof v?(e=n.message,n.type===r.NO_SELECTION&&fn("error","è¯·æ¡†é€‰æ•°æ®åŒºåŸŸ")):n instanceof Error&&(e=n.message),pn("error",e)}function yn(){const n=nn();H.value=n.provider,F.value=n.apiKey,K.value=n.apiEndpoint||"",J.value=n.model||"",bn(),_.style.display="flex"}function vn(){_.style.display="none"}function bn(){const n=H.value;if("local"===n)U.style.display="none",Y.style.display="none",G.innerHTML="<p>æœ¬åœ°æ¨¡å¼ä½¿ç”¨å…³é”®è¯åŒ¹é…ï¼Œæ— éœ€ API é…ç½®ï¼Œæ‰€æœ‰æ•°æ®æœ¬åœ°å¤„ç†ã€‚</p>";else switch(U.style.display="block",Y.style.display="block",n){case"openai":V.style.display="block",document.getElementById("endpointHint").textContent="é»˜è®¤: https://api.openai.com/v1/chat/completions",document.getElementById("modelHint").textContent="æ¨è: gpt-3.5-turbo æˆ– gpt-4",G.innerHTML="<p>ä½¿ç”¨ OpenAI APIã€‚éœ€è¦æœ‰æ•ˆçš„ API Keyã€‚</p>";break;case"azure":V.style.display="block",document.getElementById("endpointHint").textContent="å¿…å¡«ï¼Œæ ¼å¼: https://{your-resource}.openai.azure.com/...",document.getElementById("modelHint").textContent="æ ¹æ®ä½ çš„ Azure éƒ¨ç½²é…ç½®",G.innerHTML="<p>ä½¿ç”¨ Azure OpenAI æœåŠ¡ã€‚éœ€è¦é…ç½®ç«¯ç‚¹å’Œ API Keyã€‚</p>";break;case"qwen":V.style.display="none",document.getElementById("modelHint").textContent="æ¨è: qwen-turbo æˆ– qwen-plus",G.innerHTML="<p>ä½¿ç”¨é˜¿é‡Œäº‘é€šä¹‰åƒé—® APIã€‚éœ€è¦é˜¿é‡Œäº‘ DashScope API Keyã€‚</p>"}}function xn(){const n={provider:H.value,apiKey:F.value.trim(),apiEndpoint:K.value.trim()||void 0,model:J.value.trim()||void 0};"local"===n.provider||n.apiKey?"azure"!==n.provider||n.apiEndpoint?(Z(n),En(),vn(),pn("assistant",`å·²åˆ‡æ¢åˆ°${on(n.provider)}æ¨¡å¼`)):alert("Azure OpenAI éœ€è¦é…ç½® API ç«¯ç‚¹"):alert("è¯·è¾“å…¥ API Key")}async function wn(){const n={provider:H.value,apiKey:F.value.trim(),apiEndpoint:K.value.trim()||void 0,model:J.value.trim()||void 0};if(n.apiKey){Y.textContent="æµ‹è¯•ä¸­...",Y.disabled=!0;try{Z(n);const e={headers:["æµ‹è¯•å­—æ®µ"],data:[{æµ‹è¯•å­—æ®µ:100}]};await async function(n,e){if(!en())throw new Error("AI æ¨¡å‹æœªé…ç½®ï¼Œè¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key");const t=function(n){return`ä½ æ˜¯ä¸€ä¸ª Excel æ•°æ®åˆ†æåŠ©æ‰‹ã€‚ç”¨æˆ·ä¼šæå‡ºå…³äºæ•°æ®çš„æŸ¥è¯¢æˆ–å›¾è¡¨ç”Ÿæˆè¯·æ±‚ã€‚\n\nå½“å‰æ•°æ®çš„åˆ—åï¼š${n.headers.join("ã€")}\næ•°æ®æ ·ä¾‹ï¼š\n${n.data.slice(0,3).map(e=>n.headers.map(n=>`${n}: ${e[n]}`).join(", ")).join("\n")}\n\nè¯·åˆ†æç”¨æˆ·çš„è¯·æ±‚ï¼Œè¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\n{\n  "type": "query" æˆ– "chart",\n  "filters": [{"field": "å­—æ®µå", "value": "å€¼", "operator": "equals"}],\n  "calculation": "sum" | "avg" | "max" | "min" | "count" (ä»… query ç±»å‹),\n  "targetField": "è¦è®¡ç®—çš„å­—æ®µå" (ä»… query ç±»å‹),\n  "chartType": "bar" | "line" | "pie" (ä»… chart ç±»å‹),\n  "dimensions": ["ç»´åº¦å­—æ®µ"] (ä»… chart ç±»å‹),\n  "metrics": ["æŒ‡æ ‡å­—æ®µ"] (ä»… chart ç±»å‹)\n}\n\nåªè¿”å› JSONï¼Œä¸è¦æœ‰å…¶ä»–å†…å®¹ã€‚`}(e);return function(n){try{const r=n.match(/\{[\s\S]*\}/);if(!r)throw new Error("AI å“åº”ä¸­æœªæ‰¾åˆ° JSON");const o=JSON.parse(r[0]),a={type:"chart"===o.type?"chart":"query",filters:(e=o.filters||[],e.map(n=>({field:String(n.field||""),value:n.value,operator:n.operator||"equals"})).filter(n=>n.field&&void 0!==n.value))};return"query"===a.type?(a.calculation=(t=o.calculation,{sum:"sum",avg:"avg",average:"avg",max:"max",min:"min",count:"count"}[t?.toLowerCase()||""]||"sum"),a.targetField=o.targetField):(a.chartType=rn(o.chartType),a.dimensions=o.dimensions||[],a.metrics=o.metrics||[]),a}catch(e){return console.error("è§£æ AI å“åº”å¤±è´¥:",e,n),{type:"unknown",filters:[],errorMessage:"AI å“åº”è§£æå¤±è´¥ï¼Œè¯·å°è¯•é‡æ–°æé—®"}}var e,t}(await tn(t,n))}("è¯·è¿”å›ä¸€ä¸ªç®€å•çš„æµ‹è¯•å“åº”",e),alert("è¿æ¥æˆåŠŸï¼")}catch(n){alert("è¿æ¥å¤±è´¥: "+(n.message||"æœªçŸ¥é”™è¯¯"))}finally{Y.textContent="æµ‹è¯•è¿æ¥",Y.disabled=!1}}else alert("è¯·å…ˆè¾“å…¥ API Key")}function En(){const n=nn(),e=X.querySelector(".mode-dot"),t=X.querySelector(".mode-text");"local"===n.provider?(e.className="mode-dot local",t.textContent="æœ¬åœ°æ¨¡å¼"):(e.className="mode-dot ai",t.textContent=`${on(n.provider)}`)}function kn(n){const e=document.createElement("div");return e.textContent=n,e.innerHTML}!async function(){$=document.getElementById("chatContainer"),L=document.getElementById("userInput"),q=document.getElementById("submitBtn"),z=document.getElementById("fillBtn"),B=document.getElementById("clearBtn"),M=document.getElementById("selectionStatus"),j=document.getElementById("loadingOverlay"),P=document.getElementById("settingsBtn"),_=document.getElementById("settingsModal"),D=document.getElementById("closeSettingsBtn"),H=document.getElementById("providerSelect"),F=document.getElementById("apiKeyInput"),K=document.getElementById("apiEndpointInput"),J=document.getElementById("modelInput"),U=document.getElementById("apiConfigSection"),V=document.getElementById("endpointGroup"),G=document.getElementById("providerInfo"),Y=document.getElementById("testConnectionBtn"),W=document.getElementById("saveSettingsBtn"),X=document.getElementById("aiModeIndicator"),q.addEventListener("click",ln),z.addEventListener("click",dn),B.addEventListener("click",un),P.addEventListener("click",yn),D.addEventListener("click",vn),H.addEventListener("change",bn),W.addEventListener("click",xn),Y.addEventListener("click",wn),_.addEventListener("click",n=>{n.target===_&&vn()}),L.addEventListener("keydown",n=>{"Enter"!==n.key||n.shiftKey||(n.preventDefault(),ln())}),L.addEventListener("input",()=>{L.style.height="auto",L.style.height=Math.min(L.scrollHeight,100)+"px"}),function(){try{const n=localStorage.getItem("ai-excel-plugin-config");n&&(Q={...R,...JSON.parse(n)})}catch(n){console.error("åŠ è½½é…ç½®å¤±è´¥:",n)}}(),En();try{await new Promise((n,e)=>{Office.onReady(t=>{t.host===Office.HostType.Excel?n():e(new Error("æ­¤æ’ä»¶ä»…æ”¯æŒ Excel"))})}),fn("ready","æ’ä»¶å·²å°±ç»ªï¼Œè¯·æ¡†é€‰æ•°æ®åŒºåŸŸ")}catch(n){fn("error","æ’ä»¶åˆå§‹åŒ–å¤±è´¥"),console.error("Office åˆå§‹åŒ–å¤±è´¥:",n)}}()})();